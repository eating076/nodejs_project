<% if (users && (users.length > 0 || manUsers.length > 0 || allUsers.length > 0)) { %>
  <form method="POST" action="/download">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <input type="checkbox" id="selectAll" class="form-check-input" />
        <label for="selectAll" class="form-check-label">全選</label>
      </div>
      <div class="count-indicator">已勾選 <span id="selectedCount">0</span> 人</div>
    </div>

    <ul id="userList" class="mb-3">
      <%
        const resultList = table === "users" ? users : table === "man_users" ? manUsers : allUsers;
        resultList.forEach(user => {
          // ✅ 來源資料表
          const source = table === 'users+man_users' ? user.tableName : table;

          // ✅ 跳轉參數名（user_id or man_user_id）
          const queryKey = source === 'users' ? 'user_id' : 'man_user_id';

          // ✅ 顯示姓名（後端統一為 name）
          const displayName = user.name || '未提供';

          // ✅ 顯示性別（後端統一為 gender）
          const displayGender = user.gender || '未指定';

          // ✅ 跳轉連結組成
          const href = `/result?${queryKey}=${user.id}`;
      %>
        <li class="mb-2">
          <input type="checkbox" class="form-check-input user-box" name="user_ids" value="<%= user.id %>||<%= source %>">
          <a href="<%= href %>"><%= displayName %> - <%= displayGender %></a>
          <span class="arrow ms-2" style="cursor:pointer;color:#0d6efd" data-user-id="<%= user.id %>" data-table="<%= source %>">▶</span>
        </li>
      <% }) %>
    </ul>

    <button type="submit" class="btn btn-primary w-100">確認下載所選全部項目</button>
  </form>
<% } else { %>
  <p class="text-danger">⚠️ 查無相似資料</p>
<% } %>
